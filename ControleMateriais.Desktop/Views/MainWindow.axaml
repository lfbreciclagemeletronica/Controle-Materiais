<Window
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ControleMateriais.Models"
    xmlns:vm="using:ControleMateriais.Desktop.ViewModels"
    x:Class="ControleMateriais.Desktop.Views.MainWindow"
    xmlns:conv="using:ControleMateriais.Desktop.Converters"
    x:DataType="vm:MainWindowViewModel"
    Width="800" Height="500"
    Title="Controle de Materiais">

    <Window.Resources>
        <conv:BooleanNegationConverter x:Key="BoolNot"/>
    </Window.Resources>

  <Grid Background="{DynamicResource Brush.Surface}">
    <Grid RowDefinitions="Auto,*">

      <!-- TOAST (notificação simples) -->
      <Border IsVisible="{Binding ToastVisible}"
              Background="{DynamicResource ToastOkBrush}"
              Padding="10" Margin="10" CornerRadius="6">
        <TextBlock Text="{Binding ToastMessage}" Foreground="White"/>
      </Border>

      <!-- CONTAINER PRINCIPAL -->
      <Grid Grid.Row="1" Margin="10">
        <!-- Painel INICIAL -->
        <Grid IsVisible="{Binding IsEditandoPrecos, Converter={StaticResource BoolNot}}">
          <Border Background="{DynamicResource Brush.SurfaceAlt}"
                  BorderBrush="{DynamicResource Brush.Border}"
                  BorderThickness="1" CornerRadius="10" Padding="16">
            <Grid RowDefinitions="Auto,*">
              <!-- Cabeçalho -->
              <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,12">
                <Button Grid.Column="0"
                        Content="Tabela de Preços"
                        HorizontalAlignment="Left"
                        Command="{Binding AbrirEdicaoPrecosCommand}"/>

                <TextBlock Grid.ColumnSpan="2"
                           Classes="h1"
                           HorizontalAlignment="Center"
                           Text="{Binding TotalGeral, StringFormat={}{0:C}}"/>

                <Button Grid.Column="1"
                        Classes="primary"
                        Content="Exportar"
                        Command="{Binding ExportarCommand}"/>
              </Grid>

              <!-- DataGrid principal -->
              <DataGrid Grid.Row="1"
                        ItemsSource="{Binding Itens}"
                        AutoGenerateColumns="False"
                        IsReadOnly="False">
                <DataGrid.Columns>
                  <DataGridTextColumn Header="Material"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding Nome}" IsReadOnly="True" Width="2*"/>
                  <DataGridTextColumn Header="Peso atual (kg)"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding PesoAtual, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:N3}}"
                                      IsReadOnly="False" Width="*"/>
                  <DataGridTextColumn Header="Preço por kg"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding PrecoPorKg, Mode=OneWay, StringFormat={}{0:C}}"
                                      IsReadOnly="True" Width="*"/>
                  <DataGridTextColumn Header="Total"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding Total, Mode=OneWay, StringFormat={}{0:C}}"
                                      IsReadOnly="True" Width="*"/>
                </DataGrid.Columns>
              </DataGrid>
            </Grid>
          </Border>
        </Grid>

        <!-- Painel de EDIÇÃO DE PREÇOS (embute o antigo PriceTableWindow) -->
        <Grid IsVisible="{Binding IsEditandoPrecos}">
          <Border Background="{DynamicResource Brush.Surface}" Padding="16">
            <Grid RowDefinitions="Auto,*,Auto">
              <!-- Cabeçalho: competência como texto -->
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="Competência (mês/ano):"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource Brush.TextPrimary}"/>
                <TextBox Text="{Binding PriceVM.CompetenciaMes, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Width="50" MaxLength="2" VerticalAlignment="Center"/>
                <TextBlock Text="/" VerticalAlignment="Center"
                           Foreground="{DynamicResource Brush.TextPrimary}"/>
                <TextBox Text="{Binding PriceVM.CompetenciaAno, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Width="65" MaxLength="4" VerticalAlignment="Center"/>
                <TextBlock Text="(ao trocar, carrega valores, se houver JSON)"
                           Classes="muted" VerticalAlignment="Center" Margin="8,0,0,0"/>
              </StackPanel>

              <!-- Grade de preços usando ItemsControl para controle total de eventos -->
              <Border Grid.Row="1"
                      Background="{DynamicResource Brush.SurfaceAlt}"
                      BorderBrush="{DynamicResource Brush.Border}"
                      BorderThickness="1" CornerRadius="8" Padding="8">
                <StackPanel>
                  <!-- Cabeçalho -->
                  <Grid ColumnDefinitions="2*,*" Margin="4,0,4,4">
                    <TextBlock Grid.Column="0" Text="Material" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}"/>
                    <TextBlock Grid.Column="1" Text="Preço por kg" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}" HorizontalAlignment="Right"/>
                  </Grid>
                  <ItemsControl ItemsSource="{Binding PriceVM.PrecosEditaveis}"
                                x:Name="ListaPrecos">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate x:DataType="vm:ItemPrecoWrapper">
                        <Grid ColumnDefinitions="2*,*" Margin="4,2">
                          <TextBlock Grid.Column="0" Text="{Binding Nome}"
                                     VerticalAlignment="Center"
                                     Foreground="{DynamicResource Brush.TextPrimary}"/>
                          <TextBox Grid.Column="1"
                                   Text="{Binding PrecoTexto, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                   HorizontalAlignment="Right"
                                   HorizontalContentAlignment="Right"
                                   Width="140"
                                   GotFocus="PrecoTextBox_GotFocus"
                                   KeyDown="PrecoTextBox_KeyDown"
                                   LostFocus="PrecoTextBox_LostFocus"/>
                        </Grid>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>
              </Border>

              <!-- Ações -->
              <StackPanel Grid.Row="2" Orientation="Horizontal"
                          HorizontalAlignment="Right" Spacing="8">
                <Button Content="Fechar"
                        Command="{Binding PriceVM.RetornarCommand}"/>
                <Button Classes="primary"
                        Content="Salvar (JSON)"
                        Command="{Binding PriceVM.SalvarCommand}"
                        IsVisible="{Binding PriceVM.SalvoComSucesso, Converter={StaticResource BoolNot}}"/>
              </StackPanel>
            </Grid>
          </Border>
        </Grid>
      </Grid>
    </Grid>
  </Grid>
</Window>