<Window
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ControleMateriais.Models"
    xmlns:vm="using:ControleMateriais.Desktop.ViewModels"
    x:Class="ControleMateriais.Desktop.Views.MainWindow"
    xmlns:conv="using:ControleMateriais.Desktop.Converters"
    x:DataType="vm:MainWindowViewModel"
    Width="900" Height="680"
    MinWidth="700" MinHeight="500"
    CanResize="True"
    Title="Controle de Materiais"
    Icon="avares://ControleMateriais.Desktop/Assets/avalonia-logo.ico">

    <Window.Resources>
        <conv:BooleanNegationConverter x:Key="BoolNot"/>
    </Window.Resources>

  <Grid Background="{DynamicResource Brush.Surface}">
    <Grid RowDefinitions="Auto,*">

      <!-- TOAST (notificação simples) -->
      <Border IsVisible="{Binding ToastVisible}"
              Background="{DynamicResource ToastOkBrush}"
              Padding="10" Margin="10" CornerRadius="6">
        <TextBlock Text="{Binding ToastMessage}" Foreground="White"/>
      </Border>

      <!-- CONTAINER PRINCIPAL -->
      <Grid Grid.Row="1" Margin="10">
        <!-- Painel INICIAL -->
        <Grid IsVisible="{Binding IsEditandoPrecos, Converter={StaticResource BoolNot}}">
          <Border Background="{DynamicResource Brush.SurfaceAlt}"
                  BorderBrush="{DynamicResource Brush.Border}"
                  BorderThickness="1" CornerRadius="10" Padding="16">
            <Grid RowDefinitions="Auto,*">
              <!-- Cabeçalho -->
              <StackPanel Margin="0,0,0,12" Spacing="6">
                <Grid ColumnDefinitions="*,Auto">
                  <Button Grid.Column="0"
                          Content="Tabela de Preços"
                          HorizontalAlignment="Left"
                          Command="{Binding AbrirEdicaoPrecosCommand}"/>

                  <StackPanel Grid.ColumnSpan="2"
                              HorizontalAlignment="Center"
                              Spacing="0">
                    <TextBlock Text="Valor Total"
                               Classes="muted"
                               HorizontalAlignment="Center"
                               FontSize="11"/>
                    <TextBlock Classes="h1"
                               HorizontalAlignment="Center"
                               Text="{Binding TotalGeral, StringFormat={}{0:C}}"/>
                    <TextBlock HorizontalAlignment="Center"
                               FontSize="12"
                               Foreground="{DynamicResource Brush.TextPrimary}"
                               Text="{Binding PesoTotal, StringFormat={}Peso total: {0:N3} kg}"/>
                  </StackPanel>

                  <Button Grid.Column="1"
                          Classes="primary"
                          Content="Exportar"
                          Command="{Binding ExportarCommand}"/>
                </Grid>
                <Grid ColumnDefinitions="Auto,*">
                  <TextBlock Grid.Column="0"
                             Text="Nome:"
                             VerticalAlignment="Center"
                             Margin="0,0,8,0"
                             Foreground="{DynamicResource Brush.TextPrimary}"/>
                  <TextBox Grid.Column="1"
                           Text="{Binding NomeCliente, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                           Watermark="Nome do cliente / responsável (opcional)"
                           HorizontalAlignment="Stretch"/>
                </Grid>
              </StackPanel>

              <!-- Tabela principal de itens -->
              <Border Grid.Row="1"
                      Background="{DynamicResource Brush.SurfaceAlt}"
                      BorderBrush="{DynamicResource Brush.Border}"
                      BorderThickness="1" CornerRadius="8" Padding="8">
                <Grid RowDefinitions="Auto,*">
                  <!-- Cabeçalho fixo -->
                  <Grid ColumnDefinitions="*,120,110,100" Margin="4,0,12,6">
                    <TextBlock Grid.Column="0" Text="Material" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}"/>
                    <TextBlock Grid.Column="1" Text="Peso atual (kg)" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}" HorizontalAlignment="Left"/>
                    <TextBlock Grid.Column="2" Text="Preço por kg" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}" HorizontalAlignment="Left"/>
                    <TextBlock Grid.Column="3" Text="Total" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}" HorizontalAlignment="Left"/>
                  </Grid>
                  <!-- Linhas com scroll -->
                  <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding ItensEditaveis}">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="vm:PesoWrapper">
                          <Grid ColumnDefinitions="*,120,110,100" Margin="4,3">
                            <TextBlock Grid.Column="0" Text="{Binding Nome}"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource Brush.TextPrimary}"/>
                            <TextBox Grid.Column="1"
                                     Text="{Binding PesoTexto, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     HorizontalAlignment="Left"
                                     Width="110"
                                     HorizontalContentAlignment="Center"
                                     GotFocus="PesoTextBox_GotFocus"
                                     KeyDown="PesoTextBox_KeyDown"
                                     LostFocus="PesoTextBox_LostFocus"/>
                            <TextBlock Grid.Column="2"
                                       Text="{Binding PrecoPorKg, StringFormat={}{0:C}}"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Left"
                                       Foreground="{DynamicResource Brush.TextPrimary}"/>
                            <TextBlock Grid.Column="3"
                                       Text="{Binding Total, StringFormat={}{0:C}}"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Left"
                                       Foreground="{DynamicResource Brush.TextPrimary}"/>
                          </Grid>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </ScrollViewer>
                </Grid>
              </Border>
            </Grid>
          </Border>
        </Grid>

        <!-- Painel de EDIÇÃO DE PREÇOS (embute o antigo PriceTableWindow) -->
        <Grid IsVisible="{Binding IsEditandoPrecos}">
          <Border Background="{DynamicResource Brush.Surface}" Padding="16">
            <Grid RowDefinitions="Auto,*,Auto">
              <!-- Cabeçalho: competência como texto -->
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="Competência (mês/ano):"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource Brush.TextPrimary}"/>
                <TextBox Text="{Binding PriceVM.CompetenciaMes, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Width="50" MaxLength="2" VerticalAlignment="Center"/>
                <TextBlock Text="/" VerticalAlignment="Center"
                           Foreground="{DynamicResource Brush.TextPrimary}"/>
                <TextBox Text="{Binding PriceVM.CompetenciaAno, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Width="65" MaxLength="4" VerticalAlignment="Center"/>
                <TextBlock Text="(ao trocar, carrega valores, se houver JSON)"
                           Classes="muted" VerticalAlignment="Center" Margin="8,0,0,0"/>
              </StackPanel>

              <!-- Grade de preços usando ItemsControl para controle total de eventos -->
              <Border Grid.Row="1"
                      Background="{DynamicResource Brush.SurfaceAlt}"
                      BorderBrush="{DynamicResource Brush.Border}"
                      BorderThickness="1" CornerRadius="8" Padding="8">
                <Grid RowDefinitions="Auto,*">
                  <!-- Cabeçalho fixo -->
                  <Grid ColumnDefinitions="*,150" Margin="4,0,12,4">
                    <TextBlock Grid.Column="0" Text="Material" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}"/>
                    <TextBlock Grid.Column="1" Text="Preço por kg" FontWeight="Bold"
                               Foreground="{DynamicResource Brush.TextPrimary}" HorizontalAlignment="Left"/>
                  </Grid>
                  <!-- Linhas com scroll -->
                  <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding PriceVM.PrecosEditaveis}"
                                  x:Name="ListaPrecos">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="vm:ItemPrecoWrapper">
                          <Grid ColumnDefinitions="*,150" Margin="4,2">
                            <TextBlock Grid.Column="0" Text="{Binding Nome}"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource Brush.TextPrimary}"/>
                            <TextBox Grid.Column="1"
                                     Text="{Binding PrecoTexto, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     HorizontalAlignment="Left"
                                     Width="140"
                                     HorizontalContentAlignment="Right"
                                     GotFocus="PrecoTextBox_GotFocus"
                                     KeyDown="PrecoTextBox_KeyDown"
                                     LostFocus="PrecoTextBox_LostFocus"/>
                          </Grid>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </ScrollViewer>
                </Grid>
              </Border>

              <!-- Ações -->
              <StackPanel Grid.Row="2" Orientation="Horizontal"
                          HorizontalAlignment="Right" Spacing="8">
                <Button Content="Fechar"
                        Command="{Binding PriceVM.RetornarCommand}"/>
                <Button Classes="primary"
                        Content="Salvar"
                        Command="{Binding PriceVM.SalvarCommand}"
                        IsVisible="{Binding PriceVM.SalvoComSucesso, Converter={StaticResource BoolNot}}"/>
              </StackPanel>
            </Grid>
          </Border>
        </Grid>
      </Grid>
    </Grid>
  </Grid>
</Window>