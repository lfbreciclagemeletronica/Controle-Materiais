<Window
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ControleMateriais.Models"
    xmlns:vm="using:ControleMateriais.Desktop.ViewModels"
    x:Class="ControleMateriais.Desktop.Views.MainWindow"
    xmlns:conv="using:ControleMateriais.Desktop.Converters"
    x:DataType="vm:MainWindowViewModel"
    Width="800" Height="500"
    Title="Controle de Materiais">

    <Window.Resources>
        <conv:BooleanNegationConverter x:Key="BoolNot"/>
    </Window.Resources>

  <Grid Background="{DynamicResource Brush.Surface}">
    <Grid RowDefinitions="Auto,*">

      <!-- TOAST (notificação simples) -->
      <Border IsVisible="{Binding ToastVisible}"
              Background="{DynamicResource ToastOkBrush}"
              Padding="10" Margin="10" CornerRadius="6">
        <TextBlock Text="{Binding ToastMessage}" Foreground="White"/>
      </Border>

      <!-- CONTAINER PRINCIPAL -->
      <Grid Grid.Row="1" Margin="10">
        <!-- Painel INICIAL -->
        <Grid IsVisible="{Binding IsEditandoPrecos, Converter={StaticResource BoolNot}}">
          <Border Background="{DynamicResource Brush.SurfaceAlt}"
                  BorderBrush="{DynamicResource Brush.Border}"
                  BorderThickness="1" CornerRadius="10" Padding="16">
            <Grid RowDefinitions="Auto,*">
              <!-- Cabeçalho -->
              <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,12">
                <Button Grid.Column="0"
                        Content="Tabela de Preços"
                        HorizontalAlignment="Left"
                        Command="{Binding AbrirEdicaoPrecosCommand}"/>

                <TextBlock Grid.ColumnSpan="2"
                           Classes="h1"
                           HorizontalAlignment="Center"
                           Text="{Binding TotalGeral, StringFormat={}{0:C}}"/>

                <Button Grid.Column="1"
                        Classes="primary"
                        Content="Exportar"
                        Command="{Binding ExportarCommand}"/>
              </Grid>

              <!-- DataGrid principal -->
              <DataGrid Grid.Row="1"
                        ItemsSource="{Binding Itens}"
                        AutoGenerateColumns="False"
                        IsReadOnly="False">
                <DataGrid.Columns>
                  <DataGridTextColumn Header="Material"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding Nome}" IsReadOnly="True" Width="2*"/>
                  <DataGridTextColumn Header="Peso atual (kg)"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding PesoAtual, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:N3}}"
                                      IsReadOnly="False" Width="*"/>
                  <DataGridTextColumn Header="Preço por kg"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding PrecoPorKg, Mode=OneWay, StringFormat={}{0:C}}"
                                      IsReadOnly="True" Width="*"/>
                  <DataGridTextColumn Header="Total"
                                      x:DataType="models:MaterialItem"
                                      Binding="{Binding Total, Mode=OneWay, StringFormat={}{0:C}}"
                                      IsReadOnly="True" Width="*"/>
                </DataGrid.Columns>
              </DataGrid>
            </Grid>
          </Border>
        </Grid>

        <!-- Painel de EDIÇÃO DE PREÇOS (embute o antigo PriceTableWindow) -->
        <Grid IsVisible="{Binding IsEditandoPrecos}">
          <Border Background="{DynamicResource Brush.Surface}" Padding="16">
            <Grid RowDefinitions="Auto,*,Auto">
              <!-- Cabeçalho: competência -->
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="Competência (mês/ano):"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource Brush.TextPrimary}"/>
                <DatePicker SelectedDate="{Binding PriceVM.Competencia, Mode=TwoWay}"
                            Width="180"/>
                <TextBlock Text="(ao trocar, carrega valores, se houver JSON)"
                           Classes="muted" VerticalAlignment="Center" Margin="8,0,0,0"/>
              </StackPanel>

              <!-- Grade de preços -->
              <Border Grid.Row="1"
                      Background="{DynamicResource Brush.SurfaceAlt}"
                      BorderBrush="{DynamicResource Brush.Border}"
                      BorderThickness="1" CornerRadius="8" Padding="8">
                <DataGrid ItemsSource="{Binding PriceVM.Precos}"
                          AutoGenerateColumns="False" IsReadOnly="False">
                  <DataGrid.Columns>
                    <DataGridTextColumn Header="Material"
                                        x:DataType="models:MaterialItem"
                                        Binding="{Binding Nome}" IsReadOnly="True" Width="2*"/>
                    <!-- edição de moeda: use seu converter ou TwoWay direto se preferir -->
                    <DataGridTextColumn Header="Preço por kg"
                                        x:DataType="models:MaterialItem"
                                        Binding="{Binding PrecoPorKg, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:C}}"
                                        Width="*"/>
                  </DataGrid.Columns>
                </DataGrid>
              </Border>

              <!-- Ações -->
              <StackPanel Grid.Row="2" Orientation="Horizontal"
                          HorizontalAlignment="Right" Spacing="8">
                <Button Content="Fechar"
                        Command="{Binding PriceVM.RetornarCommand}"/>
                <Button Classes="primary"
                        Content="Salvar (JSON)"
                        Command="{Binding PriceVM.SalvarCommand}"
                        IsVisible="{Binding PriceVM.SalvoComSucesso, Converter={StaticResource BoolNot}}"/>
              </StackPanel>
            </Grid>
          </Border>
        </Grid>
      </Grid>
    </Grid>
  </Grid>
</Window>